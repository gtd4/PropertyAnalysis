@model PropertyAnalysisTool.Models.TradeMePropertyResultsViewModel
@{
    ViewBag.Title = "Home Page";

}

<div class="row">

    <div class="col-sm-8" id="property-list">
        @{Html.RenderPartial("PropertyListingPartial", Model);}

    </div>
    <div class="col-sm-4">
        @{Html.RenderAction("Index", "PropertyFilter");}
        <div class="row">
            <div class="to-compare col-sm-12">
                <h3>To Compare</h3>

                <div class="compare-list">

                </div>
                <button type="button" class="btn btn-primary compare-properties">Compare Properties</button>

            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script>
        var compareList = [];

        function UpdateFilter(localityId, districtId, SuburbId) {
            $.ajax({
                url: "/PropertyFilter/Index",
                type: "GET",
                data: {
                    LocalityId: localityId,
                    DistrictId: districtId,
                    SuburbId: SuburbId,
                    rng: Math.random()
                }
            }).done(function (partialViewResult) {

                $("#propertyfilter-container").html(partialViewResult);

            });

            UpdateProperties(localityId, districtId, SuburbId)
        }

        function UpdateProperties(localityId, districtId, suburbId, page) {
            $.ajax({
                url: "/Home/UpdatePropertyListings",
                type: "GET",
                data: {
                    LocalityId: localityId,
                    DistrictId: districtId,
                    SuburbId: suburbId,
                    Page: page,
                    rng: Math.random()
                }
            }).done(function (partialViewResult) {

                $("#property-list").html(partialViewResult);

            });
        }

        function BuildItemContainer(propId) {

            var itemContainer = jQuery("<div/>",
            {
                class: 'compare-item-container col-sm-12',
                id: propId,

            });

            return itemContainer;
        }

        function BuildTitleContainer(title) {

            var titleContainer = jQuery("<div/>",
            {
                class: 'compare-title-container',

            });

            var title = jQuery("<p/>",
                {
                    text: title,
                }).appendTo(titleContainer);

            return titleContainer;
        }

        function BuildImgContainer(imgSrc) {

            var imgContainer = jQuery("<div/>",
                {
                    class: 'compare-img-container',
                });
            var img = jQuery("<img/>",
                {
                    src: imgSrc,

                }).appendTo(imgContainer);

            return imgContainer;

        }

        function BuildDeleteContainer(propId) {
            var deleteContainer = jQuery("<div/>",
                {
                    class: "compare-delete-container",
                });

            var deleteButton = jQuery("<button/>",
            {
                class: "btn btn-danger compare-delete-button",
                text: "Remove",
                value: propId,
            }).appendTo(deleteContainer);

            return deleteContainer;
        }

        function ToggleComparePropertyButton() {

            if (compareList.length > 1) {
                $(".compare-properties").show();
            }
            else {
                $(".compare-properties").hide();
            }
        }

        function BuildCompareListItem(title, imgSrc, propId) {

            if (compareList.length >= 3) {
                alert("You can only compare a max of 3 properties at 1 time");
                return true;
            }



            if (jQuery.inArray(propId, compareList) != -1) {
                alert("You have already added this property to be compared");
                return true;
            }

            compareList.push(propId);

            ToggleComparePropertyButton();

            var compareListContainer = $(".compare-list");

            var itemContainer = BuildItemContainer(propId);
            var imgContainer = BuildImgContainer(imgSrc);
            var titleContainer = BuildTitleContainer(title);
            var deleteContainer = BuildDeleteContainer(propId);

            $(imgContainer).appendTo(itemContainer);
            $(titleContainer).appendTo(itemContainer);
            $(deleteContainer).appendTo(itemContainer);

            $(itemContainer).appendTo(compareListContainer);

        }

        function RemoveFromCompareList(propId)
        {
            var index = jQuery.inArray(propId, compareList);

            if(index != -1)
            {
                compareList.splice(index, 1);
                return true;
            }
        }

        $(function () {

            $("#propertyfilter-container").on('change', '#SelectedLocationId', function () {

                UpdateFilter($(this).val(), 0, 0)

            });

            $("#propertyfilter-container").on('change', '#SelectedDistrictId', function () {

                UpdateFilter($("#SelectedLocationId").val(), $("#SelectedDistrictId").val(), 0)


            });

            $("#propertyfilter-container").on('change', '#SelectedSuburbId', function () {

                UpdateProperties($("#SelectedLocationId").val(), $("#SelectedDistrictId").val(), $("#SelectedSuburbId").val());

            });

            $(".compare-button").click(function (e) {

                e.preventDefault();

                var id = $(this).val();
                var title = $(this).siblings(".prop-title").text();
                var image = $(this).siblings(".prop-img").prop("src");

                BuildCompareListItem(title, image, id);

            });

            $(".compare-list").on('click', '.compare-delete-button', function () {

                var propId = $(this).val();
                //remove entire container
                var selector = "#" + propId;

                $(".compare-list").find(selector).remove();

                //remove item for compareList
                RemoveFromCompareList(propId);

                //hide compare button
                ToggleComparePropertyButton();
            });
        });

    </script>
}